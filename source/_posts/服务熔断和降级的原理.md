---
layout: posts
title: 服务的降级熔断和限流- Hystrix和Sentinel
date: 2021-03-12 15:54:47
categories: 学习笔记
tags: [降级熔断, 限流, Hystrix, Sentinel]
---



## 服务的降级熔断和限流- Hystrix和Sentinel



### Hystrix

关于api的降级熔断和限流的实现原理，以下是hystrix为例，hystrix为我们提供了两种模式的执行逻辑：

①线程池（默认）

②信号量



<!-- more -->

#### 如何修改执行逻辑的模式

在配置文件里面：

execution.isolation.strategy = ExecutionIsolationStrategy.SEMAPHORE



#### 关于两者的区别

①信号量模式

在该模式下，接受请求和下游执行需要在同一个线程内完成，不存在上下文线程切换带来的性能开销，所以大部分场景下都应该使用信号量模式，但是如果在一个业务逻辑里面需要调用到多个其他服务的接口，且这种调用不存在上下文的依赖关系，对于该业务的执行时间就是所有接口调用耗时的总和。为了限制对下游接口的并发调用量，可以配置Hystrix的

```xml
execution.isolation.semaphore.maxConcurrentRequests
```

当并发请求调用量达到阈值时，可以快速失败，执行降级。

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy8yMTg0OTUxLWJiOTk0NjdhMTU1Mjg0NTYucG5nP2ltYWdlTW9ncjIvYXV0by1vcmllbnQvc3RyaXB8aW1hZ2VWaWV3Mi8yL3cvMTIwMC9mb3JtYXQvd2VicA?x-oss-process=image/format,png)

②线程池模式

在该模式下，每一个command都会建立一个对应的线程池，用户请求会被放到各自的线程池中处理，达到资源隔离的作用，当线程池来不及处理请求可以执行快速失败的逻辑，避免问题扩散。

* 优势
  * 减少服务发生故障时的影响面
  * 接口性能有变动，可以进行动态调整
* 劣势
  * 用户请求都是在线程池执行，会带来任务调度、上下文切换的开销



### Sentinel

Sentinel 具有以下特征：

- **丰富的应用场景**：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。
- **完备的实时监控**：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。
- **广泛的开源生态**：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。
- **完善的 SPI 扩展点**：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。



### hystrix和sentinel对比

|                | Sentinel                                       | Hystrix                       |
| :------------- | :--------------------------------------------- | :---------------------------- |
| 隔离策略       | 信号量隔离（并发线程数限流）                   | 线程池隔离/信号量隔离         |
| 熔断降级策略   | 基于响应时间、异常比率、异常数                 | 基于异常比率                  |
| 实时指标实现   | 滑动窗口（LeapArray）                          | 滑动窗口（基于 RxJava）       |
| 规则配置       | 支持多种数据源                                 | 支持多种数据源                |
| 扩展性         | 多个扩展点                                     | 插件的形式                    |
| 基于注解的支持 | 支持                                           | 支持                          |
| 调用链路信息   | 支持同步调用                                   | 不支持                        |
| 限流           | 基于 QPS / 并发数，支持基于调用关系的限流      | 有限支持                      |
| 流量整形       | 支持慢启动、匀速器模式                         | 不支持                        |
| 系统负载保护   | 支持                                           | 不支持                        |
| 控制台         | 开箱即用，可配置规则、查看秒级监控、机器发现等 | 较为简单                      |
| 常见框架的适配 | Servlet、Spring Cloud、Dubbo、gRPC 等          | Servlet、Spring Cloud Netflix |

